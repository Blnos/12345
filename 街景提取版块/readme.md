# 百度街景爬虫

街景提取的思路是：

 `` 确认各个街道范围-->
 提取各个街道osm路网-->
 整理osm路网[合并双向路、删除冗余路网等]-->
 路网打点-->路网点坐标转化-->
 由路网点提取街景 ``

## 1. 背景与核心挑战

在进行百度街景（Street View）自动化采集时，最核心的技术难点在于**多重坐标系的精确转换**。

* **原始数据**：我们持有的路网数据基于 **WGS84 坐标系**（即通用 GPS 坐标）。
* **目标系统**：百度街景底层使用的是 **百度墨卡托坐标系 (Baidu Mercator, MC)**。这是一个基于米制的平面投影坐标系，不同于常见的经纬度。
* **难点**：
  百度地图为了数据安全，对坐标进行了非线性的二次加密（WGS84 $\rightarrow$ GCJ02 $\rightarrow$ BD09）。若使用通用的数学公式（如 Proj4/GDAL）进行转换，在北京等高纬度地区会产生 **500米至 2公里** 的非线性偏移。
  *后果：导致请求街景时位置错乱（如坐标在三里屯，却抓取到了昌平的图像）。*

## 2. 解决方案概述

为了解决上述“坐标漂移”问题并兼顾“API 成本控制”，本项目采用了 **“官方 API 批量预处理 + 底层接口抓取”** 的双层架构方案。

### 核心流程图

```mermaid
graph LR
    A[OSM路网提取] -->|Step 0: 生成| B(原始 WGS84 坐标)
    B -->|Step 1: 批量预处理| C(百度官方 Geoconv API)
    C -->|参数: from=1 to=6| D[百度墨卡托坐标 MC]
    D -->|Step 2: 街景索引| E(qsdata 接口)
    E -->|解析 JSON| F[全景唯一 ID panoid]
    F -->|Step 3: 图像下载| G(pr3d 接口)
    G -->|保存| H[最终街景图片]

```

---

## 3. 详细技术实现逻辑

### 第一阶段：高精度坐标批量预处理 (Cost-Efficient Pre-processing)

为了消除数学计算的误差，我们放弃了本地估算，转而使用百度官方的 Web 服务 API，但我们在策略上做了深度优化以节省成本。

* **接口选择**：使用 `geoconv/v1` 接口。
* **参数策略**：设置参数 `from=1` (WGS84) 和 `to=6` (百度墨卡托)。

  * *技术原理*：`to=6` 是一个高级参数，它指示服务器直接返回投影后的**米制坐标 (MC)**，一步到位，避免了“先转百度经纬度(BD09LL)再转墨卡托”的二次调用。
* **批量策略**：利用 API 的并发特性，将原始坐标点每 **100个** 打包成一组发送。

  * *效益*：百度 API 计费是按“次”计算。通过批量打包，我们将 **100个点的转换成本降低为 1次配额**，极大降低了大规模抓取的费用（节省 99% 成本）。
* **结果**：获得官方校准的墨卡托坐标（精度误差 < 1米），并追加写入 CSV 文件。

### 第二阶段：街景 ID 反查与图像获取 (Data Acquisition)

在获得精准的墨卡托坐标后，绕过前端网页渲染逻辑，直接调用百度地图底层的瓦片数据接口。

1. **空间索引查询 (PanoID Retrieval)**

   * **输入**：预处理得到的墨卡托坐标 $(x, y)$。
   * **接口**：`mapsv0.bdimg.com/?qt=qsdata`。完整格式：`http://mapsv0.bdimg.com/?qt=qsdata&x=请填入&y=请填入
`
   * **原理**：这是百度地图内部的“吸附”接口。它会查找该坐标半径范围内（通常约 20-50米）最近的一个全景拍摄点，并返回该点的唯一标识符 **(PanoID)**。
     * 以传入`"x":1294909300,"y":483793900`为例,返回:``{"content":{"RoadId":"72c66c-5374-0e4c-0620-3bf218","RoadName":"","id":"0900220012230110132937883AP","x":1294909300,"y":483793900},"result":{"action":0,"error":0}}``
   * *优势*：该接口无需鉴权（AK），且因为我们传入的是官方校准过的 MC 坐标，命中率接近 100%。

2. **图像切片下载 (Image Download)**

   * **输入**：PanoID + 视角参数 (Heading)。
   * **接口**：`mapsv0.bdimg.com/?qt=pr3d`。完整格式：`https://mapsv0.bdimg.com/?qt=pr3d&fovy=90&quality=100&panoid=请填入&heading=0&pitch=0&width=480&height=320
`
   * **逻辑**：根据路网拓扑，分别请求 0° (北)、90° (东)、180° (南)、270° (西) 四个方向的静态视图，构建完整的环境感知数据。

---




## 项目内容
### 街景提取的主程序('beijing-road'文件夹)：

该文件夹包含街景提取全工作文件。


+ [cache](beijing-road/cache)文件夹：所有工作过程中产生的缓存历史数据。
+ [路网提取](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96)文件夹：
  + [路网提取.py](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96.py) 可实现：
    1. 输入区域范围的json格式文件
    2. 提取范围内osm路网
    3. 整理osm路网--路网上打点
    4. 输出路网点
    5. 同时输出一些辅助验证的数据（例如：道路简化过程中生成的缓冲带、中心线等，可以用来根据实际情况验证并调节程序中的参数大小）
  + [百度墨卡托坐标转换.py](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96/%E7%99%BE%E5%BA%A6%E5%A2%A8%E5%8D%A1%E6%89%98%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2.py) 可实现：
    + 调用百度AK，将[路网提取.py](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96.py)中生成的路网点（wgs84坐标）转为百度墨卡托投影
  +  [output_road_network](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96/output_road_network)文件夹：路网提取.py文件的输出
      + [road_points_wgs84](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96/output_road_network/road_points_wgs84) 街景提取时要用到的路网点（wgs84坐标）
      + [road_points_mc](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96/output_road_network/road_points_mc) 已经转换为百度墨卡托投影的路网点
      + [辅助验证数据](beijing-road/%E8%B7%AF%E7%BD%91%E6%8F%90%E5%8F%96/output_road_network/%E8%BE%85%E5%8A%A9%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE) 道路中心线，缓冲区等过程数据
  
+ [街景提取](beijing-road/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96)文件夹：
  + [街景提取_noAK.py](beijing-road/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96_noAK.py) 无需AK的提取脚本,精度不高，暂不使用
  + [街景提取_test.py](beijing-road/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96_test.py) 需要传入经过转换后的百度墨卡托坐标的提取脚本；暂时用这个
  + [image_dir](beijing-road/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96/image_dir) 街景提取_AK.py的工作结果
    + xxx_街道images：每个街道的街景图像，命名规则为：路网点序号_街道名称_经度_纬度_方位角_俯仰角
    + error_points：未能成功提取的街道路网点
      + 第 1 至 N 列	原始数据	也就是 point_xxx.csv 里原来的所有列（ID、经纬度等），完全原样保留。
      + 最后一列	error_info	这是程序自动添加的新列，记录具体的错误信息。
      
+ 另外几个辅助数据文件夹都是过程中验证代码效果的，没有实际调用；仅供参考

  
## 环境依赖(待完善)
   当前我的python版本Python 3.10.19
   完整运行全部项目需要安装[requirements.txt](requirements.txt)中的依赖（Anaconda 中直接导出的）
   仅运行[街景提取_noAK.py](beijing-road/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96/%E8%A1%97%E6%99%AF%E6%8F%90%E5%8F%96_noAK.py)应该不用额外装什么？
　　

